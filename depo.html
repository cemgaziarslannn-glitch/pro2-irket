<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<title>Firebase KullanÄ±m Durumu</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
body {
  font-family: Arial, sans-serif;
  background: #0f172a;
  color: #e5e7eb;
  padding: 20px;
  display: none; /* BaÅŸlangÄ±Ã§ta gizli, login sonrasÄ± gÃ¶sterilecek */
}
.card {
  background: #020617;
  border-radius: 12px;
  padding: 20px;
  max-width: 480px;
  margin: auto;
}
h2 { margin-bottom: 10px; }
.progress {
  background: #1e293b;
  border-radius: 8px;
  overflow: hidden;
  height: 22px;
}
.progress-bar {
  height: 100%;
  width: 0%;
  background: #22c55e;
  transition: 0.4s;
}
.warn { background: #f59e0b !important; }
.danger { background: #ef4444 !important; }
.stat {
  margin-top: 8px;
  font-size: 14px;
}
.small {
  opacity: 0.7;
  font-size: 12px;
  margin-top: 10px;
}
</style>
</head>
<body>

<div class="card">
  <h2>ðŸ“¦ Firebase KullanÄ±m Durumu</h2>

  <div class="progress">
    <div id="bar" class="progress-bar"></div>
  </div>

  <div class="stat">KullanÄ±lan: <b id="used">0</b> MB</div>
  <div class="stat">Kalan: <b id="remaining">0</b> MB</div>
  <div class="stat">Doluluk: <b id="percent">0</b> %</div>

  <div class="small">
    * Tahmini hesap (%90â€“95 doÄŸruluk)
  </div>
</div>

<script>
// ðŸ”¥ FIREBASE BAÄžLANTISI
firebase.initializeApp({
  apiKey: "AIzaSyCye0QlekBFonTxfeBIlhLc9ia-mleyfUM",
  authDomain: "denetleme-4d3d9.firebaseapp.com",
  databaseURL: "https://denetleme-4d3d9-default-rtdb.firebaseio.com",
  projectId: "denetleme-4d3d9"
});

const db = firebase.database();
const auth = firebase.auth();

// ðŸ” SAYFA GÃœVENLÄ°ÄžÄ°: Sadece giriÅŸ yapmÄ±ÅŸ kullanÄ±cÄ±lar gÃ¶rebilir
auth.onAuthStateChanged(user => {
  if (!user) {
    // GiriÅŸ yoksa login sayfasÄ±na yÃ¶nlendir
    window.location.href = "index.html"; // kendi login sayfan
  } else {
    // GiriÅŸ varsa sayfayÄ± gÃ¶ster
    document.body.style.display = "block";
    initFirebaseUsage();
  }
});

// ðŸ”¢ yardÄ±mcÄ±lar
function estimateSize(obj) {
  return new Blob([JSON.stringify(obj)]).size;
}
function bytesToMB(bytes) {
  return bytes / 1024 / 1024;
}

const LIMIT_MB = 1024; // Spark limiti
let totalBytes = 0;

// ðŸ‘¤ PERSONNEL + FOTO
function initFirebaseUsage() {
  db.ref("personnel").once("value")
  .then(snap => {
    snap.forEach(p => {
      const d = p.val();
      totalBytes += estimateSize(d);
      if (d.photoBase64) {
        totalBytes += Math.round((d.photoBase64.length * 3) / 4);
      }
    });
    return db.ref("projects").once("value");
  })
  .then(snap => {
    totalBytes += estimateSize(snap.val() || {});
    return db.ref("denetimler").once("value");
  })
  .then(snap => {
    totalBytes += estimateSize(snap.val() || {});

    const usedMB = bytesToMB(totalBytes);
    const percent = Math.min((usedMB / LIMIT_MB) * 100, 100);

    document.getElementById("used").innerText = usedMB.toFixed(2);
    document.getElementById("remaining").innerText = (LIMIT_MB - usedMB).toFixed(2);
    document.getElementById("percent").innerText = percent.toFixed(1);

    const bar = document.getElementById("bar");
    bar.style.width = percent + "%";

    if (percent >= 90) bar.classList.add("danger");
    else if (percent >= 75) bar.classList.add("warn");
  })
  .catch(err => alert("Hata: " + err.message));
}
</script>

</body>
</html>
