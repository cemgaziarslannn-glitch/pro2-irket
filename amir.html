<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<title>G√ºnl√ºk Denetim Raporu</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
/* ===== GENEL ===== */
body{
 margin:0;
 font-family:system-ui,-apple-system,Segoe UI,Roboto;
 background:#f3f5f7;
 color:#111;
 display:none; /* Sayfa gizli ba≈üta */
}
.container{
 max-width:900px;
 margin:auto;
 padding:16px;
}
h1{
 margin:8px 0 16px;
 font-size:22px;
}

/* ===== √úST BAR ===== */
.top-bar{
 display:flex;
 flex-wrap:wrap;
 gap:10px;
 margin-bottom:12px;
}
input,select{
 padding:10px;
 border-radius:8px;
 border:1px solid #ddd;
 background:#fff;
}

/* ===== Bƒ∞LGƒ∞ ===== */
.info-box{
 background:#e8f1ff;
 border:1px solid #b6d0ff;
 padding:10px;
 border-radius:8px;
 margin-bottom:12px;
 font-weight:600;
 display:none;
}

/* ===== √ñZET ===== */
.summary{
 display:grid;
 grid-template-columns:repeat(auto-fit,minmax(160px,1fr));
 gap:10px;
 margin-bottom:16px;
}
.summary div{
 background:#fff;
 padding:12px;
 border-radius:10px;
 box-shadow:0 2px 6px rgba(0,0,0,.05);
 font-size:13px;
 text-align:center;
 display:flex;
 flex-direction:column;
 align-items:center;
 justify-content:center;
}
.summary div b{
 display:block;
 margin-top:6px;
 font-size:20px;
 font-weight:700;
}

/* ===== Lƒ∞STE ===== */
.list{
 display:flex;
 flex-direction:column;
 gap:14px;
}

/* ===== PROJE KART ===== */
.project{
 background:#fff;
 border-radius:14px;
 box-shadow:0 6px 16px rgba(0,0,0,.06);
 overflow:hidden;
}
.project-header{
 padding:14px 16px;
 display:flex;
 justify-content:space-between;
 align-items:flex-start;
 cursor:pointer;
 background:#f9fafb;
 border-bottom:1px solid #eee;
}
.project-title{
 font-size:16px;
 font-weight:700;
}
.project-sub{
 font-size:12px;
 color:#666;
 margin-top:4px;
}
.project-time{
 font-size:12px;
 background:#eef2ff;
 color:#3730a3;
 padding:4px 10px;
 border-radius:999px;
 white-space:nowrap;
}
.project-body{
 display:none;
 padding:8px 16px 14px;
}

/* PERSONEL */
.person{
 background:#fff;
 border-radius:10px;
 padding:12px 14px 12px 16px;
 margin:8px 0;
 display:flex;
 justify-content:space-between;
 align-items:center;
 box-shadow:0 2px 6px rgba(0,0,0,.05);
 border:1px solid #eee;
 position:relative;
 padding-left:14px;
}
.person::before{
 content:"";
 position:absolute;
 left:0;
 top:8px;
 bottom:8px;
 width:6px;
 border-radius:6px;
 background:#16a34a;
 box-shadow:2px 0 6px rgba(22,163,74,.45);
}
.person.bad::before{
 background:#dc2626;
 box-shadow:2px 0 6px rgba(220,38,38,.45);
}
.person.bad{
 border-color:#ffd6d6;
 background:#fffafa;
}
.person-name{
 font-weight:600;
}
.person-status{
 font-size:13px;
 padding:4px 10px;
 border-radius:999px;
 font-weight:600;
}
.person-status.ok{
 background:#eaf7ef;
 color:#15803d;
}
.person-status.bad{
 background:#ffecec;
 color:#b91c1c;
}
.reason{
 font-size:12px;
 color:#b00000;
 margin-left:6px;
 font-style:italic;
}

/* MOBƒ∞L */
@media(max-width:600px){
 .project-header{
  flex-direction:column;
  gap:6px;
 }
 .project-time{
  align-self:flex-start;
 }
}
/* ‚éã MEN√ú BUTONU */
.menu-exit-btn{
 position:fixed;         /* Ekrana sabitler */
 top:12px;               /* √ústten 12px bo≈üluk */
 right:12px;             /* Saƒüdan 12px bo≈üluk */
 z-index:9999;           /* Her ≈üeyin √ºst√ºnde g√∂r√ºn√ºr */
 padding:8px 12px;       /* ƒ∞√ß bo≈üluk */
 border-radius:12px;     /* K√∂≈üeleri yuvarlatƒ±r */
 font-size:13px;         /* Yazƒ± boyutu */
 background:linear-gradient(135deg,#ff4d4d,#b30000); /* Arkaplan rengi */
 color:#fff;             /* Yazƒ± rengi */
 border:none;            /* √áer√ßeve yok */
 box-shadow:0 6px 18px rgba(255,0,0,.5); /* Hafif g√∂lge */
 cursor:pointer;         /* Fare √ºzerine gelince pointer */
}

</style>
</head>

<body>
<div class="container">
<button class="menu-exit-btn" onclick="goMenu()">‚éã</button>

<h1>üìã G√ºnl√ºk Denetim Raporu</h1>

<div class="top-bar">
 <input type="date" id="datePicker">
 <select id="denetleyenSelect">
  <option value="">üëÆ Denetleme Personeli (T√ºm√º)</option>
 </select>
</div>

<div class="info-box" id="denetleyenInfo"></div>

<div class="summary" id="summary"></div>
<div class="list" id="projectList"></div>

</div>

<script>
firebase.initializeApp({
 apiKey:"AIzaSyCye0QlekBFonTxfeBIlhLc9ia-mleyfUM",
 authDomain:"denetleme-4d3d9.firebaseapp.com",
 databaseURL:"https://denetleme-4d3d9-default-rtdb.firebaseio.com",
 projectId:"denetleme-4d3d9"
});

const db=firebase.database();
const auth=firebase.auth();

// ===== AUTH KORUMASI =====
auth.onAuthStateChanged(user => {
 if(!user){
   alert("Giri≈ü yapmanƒ±z gerekiyor");
   location.replace("login.html");
 } else {
auth.onAuthStateChanged(user => {
  if(!user){
    alert("Giri≈ü yapmanƒ±z gerekiyor");
    location.replace("login.html");
  } else {
    // Kullanƒ±cƒ± giri≈ü yapmƒ±≈ü, sayfayƒ± g√∂ster
    document.body.style.display="block";
  }
});

 }
});
// MEN√ú BUTONU
function goMenu(){
  window.location.href="men√º.html";
}

/* ===== ORJƒ∞NAL RAPOR KODLARI ===== */
const projeAdlari={}, personelAdlari={}, denetleyenler={};
let uygunsuzAcik=false;
let seciliDenetleyen="";

db.ref("projects").once("value",s=>{ s.forEach(p=>{ projeAdlari[p.key]=p.val().projectName; }); });
db.ref("personnel").once("value",s=>{ s.forEach(p=>{ personelAdlari[p.key]=p.val().adSoyad; }); });

db.ref("denetimler").once("value",snap=>{
 snap.forEach(p=>{ p.forEach(tc=>{ tc.forEach(l=>{
   const x=l.val();
   if(x.denetleyenUid){ denetleyenler[x.denetleyenUid]=x.denetleyenAd; }
 }); }); });
 const sel=document.getElementById("denetleyenSelect");
 Object.entries(denetleyenler).forEach(([uid,ad])=>{
   const o=document.createElement("option"); o.value=uid; o.textContent=ad; sel.appendChild(o);
 });
});

denetleyenSelect.onchange=()=>{ seciliDenetleyen=denetleyenSelect.value;
 if(seciliDenetleyen){ denetleyenInfo.style.display="block"; denetleyenInfo.textContent=
  `Denetleme Personeli ${denetleyenler[seciliDenetleyen]} Denetlediƒüi Proje Ve Personel Bilgileri G√∂r√ºnt√ºlenmektedir.`; }
 else{ denetleyenInfo.style.display="none"; } load(); };

datePicker.value=new Date().toISOString().split("T")[0];
datePicker.onchange=load;
load();

function load(){
 const d=new Date(datePicker.value);
 const start=new Date(d.setHours(0,0,0,0)).getTime();
 const end=new Date(d.setHours(23,59,59,999)).getTime();

 summary.innerHTML=""; projectList.innerHTML="";
 let first=null,last=null,uygunsuz=0;
 const projSet=new Set(), perSet=new Set(); const projData={};

 db.ref("denetimler").once("value",snap=>{
  snap.forEach(p=>{ p.forEach(tc=>{ tc.forEach(l=>{
   const x=l.val();
   if(x.tarih<start||x.tarih>end) return;
   if(seciliDenetleyen && x.denetleyenUid!==seciliDenetleyen) return;

   projSet.add(p.key); perSet.add(tc.key);
   first=first?Math.min(first,x.tarih):x.tarih;
   last =last ?Math.max(last ,x.tarih):x.tarih;
   if(x.durum!=="gorevi_basinda") uygunsuz++;

   if(!projData[p.key]){ projData[p.key]={min:x.tarih,max:x.tarih,people:[],denetleyen:x.denetleyenAd}; }
   projData[p.key].min=Math.min(projData[p.key].min,x.tarih);
   projData[p.key].max=Math.max(projData[p.key].max,x.tarih);
   projData[p.key].people.push({ ad:personelAdlari[tc.key]||tc.key, durum:x.durum, gerekce:x.detay||"Belirtilmedi" });
  }); }); });

  summary.innerHTML=`
   <div>üìÖ Tarih<br><b>${datePicker.value}</b></div>
   <div>üïò ƒ∞lk Denetleme<br><b>${first?new Date(first).toLocaleTimeString("tr-TR"):"-"}</b></div>
   <div>üïî Son Denetleme<br><b>${last?new Date(last).toLocaleTimeString("tr-TR"):"-"}</b></div>
   <div>üìç Denetlenen Proje<br><b>${projSet.size}</b></div>
   <div>üëÆ Denetlenen Personel<br><b>${perSet.size}</b></div>
   <div style="background:#ffecec;cursor:pointer" onclick="showOnlyUygunsuz()">
    ‚ö†Ô∏è Uygunsuz Personel<br><b>${uygunsuz}</b>
   </div>
  `;

  Object.entries(projData).forEach(([pid,v])=>{
   const hasBad=v.people.some(p=>p.durum!=="gorevi_basinda");
   const id="p_"+pid;

   projectList.innerHTML+=`
    <div class="project">
     <div class="project-header" onclick="toggle('${id}')">
      <div>
       <div class="project-title">${projeAdlari[pid]||pid}</div>
       ${!seciliDenetleyen?`<div class="project-sub">Denetleyen: ${v.denetleyen}</div>`:''}
      </div>
      <div class="project-time">
       ${new Date(v.min).toLocaleTimeString("tr-TR")} ‚Äì ${new Date(v.max).toLocaleTimeString("tr-TR")}
      </div>
     </div>

     <div class="project-body" id="${id}" data-has-uygunsuz="${hasBad}">
      ${v.people.map(p=>`
<div class="person ${p.durum!=='gorevi_basinda'?'bad':''}">
        <div>
        <div class="person-name">
 ${p.ad}
 ${p.durum!=='gorevi_basinda' ? `<span class="reason">(${p.gerekce})</span>` : ''}
</div>
        </div>
        <div class="status ${p.durum==='gorevi_basinda'?'ok':'bad'}">
         ${p.durum==='gorevi_basinda'?'G√∂revde':'Uygunsuz'}
        </div>
       </div>
      `).join("")}
     </div>
    </div>
   `;
  });
 });
}

function toggle(id){ const el=document.getElementById(id); el.style.display=el.style.display==="block"?"none":"block"; }

function showOnlyUygunsuz(){
 if(uygunsuzAcik){
  document.querySelectorAll(".project-body").forEach(b=>b.style.display="none");
  uygunsuzAcik=false; return;
 }
 document.querySelectorAll(".project-body").forEach(b=>b.style.display="none");
 document.querySelectorAll(".project-body").forEach(b=>{ if(b.dataset.hasUygunsuz==="true") b.style.display="block"; });
 document.querySelector(".list").scrollIntoView({behavior:"smooth"});
 uygunsuzAcik=true;
}
</script>
</body>
</html>
